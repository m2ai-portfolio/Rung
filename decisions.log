# Rung Architecture Decisions Log

## Format
Each decision follows this structure:
- **Date**: When the decision was made
- **Decision**: What was decided
- **Context**: Why this decision was needed
- **Options Considered**: Alternatives evaluated
- **Rationale**: Why this option was chosen
- **Consequences**: Trade-offs and implications
- **Status**: Accepted | Superseded | Deprecated

---

## ADR-001: LLM Provider Selection

**Date**: 2026-01-31
**Status**: Accepted

### Decision
Use AWS Bedrock (Claude) as the exclusive LLM provider for all AI inference.

### Context
The system requires LLM capabilities for:
- Clinical analysis (Rung agent)
- Client guide generation (Beth agent)
- Framework extraction
- Pattern detection

### Options Considered
1. **Direct Anthropic API** - Lower latency, simpler integration
2. **AWS Bedrock (Claude)** - HIPAA BAA available, AWS-native
3. **Azure OpenAI** - HIPAA compliant, GPT-4 available
4. **Self-hosted open source** - Full control, no external calls

### Rationale
- AWS Bedrock provides HIPAA BAA coverage, which is mandatory for PHI processing
- Keeps all infrastructure within AWS for simplified compliance and networking
- Claude 3.5 Sonnet provides excellent clinical reasoning capabilities
- Avoids data egress to third-party APIs for PHI content

### Consequences
- **Positive**: Single compliance boundary (AWS), simplified BAA
- **Positive**: Lower latency (no cross-cloud traffic)
- **Negative**: Tied to AWS ecosystem
- **Negative**: May have higher per-token cost than direct API
- **Mitigation**: Monitor costs, evaluate provisioned throughput for high volume

---

## ADR-002: Orchestration Engine Selection

**Date**: 2026-01-31
**Status**: Accepted

### Decision
Use self-hosted n8n on EC2 for workflow orchestration instead of n8n cloud or AWS Step Functions.

### Context
Need a workflow orchestration system that:
- Can be covered under HIPAA BAA
- Supports complex conditional logic
- Has good visibility/debugging
- Integrates with AWS services

### Options Considered
1. **AWS Step Functions** - Native AWS, excellent integration
2. **n8n Cloud** - Managed, easy setup, but no BAA available
3. **n8n Self-hosted** - HIPAA possible, full control
4. **Temporal** - Excellent reliability, steeper learning curve
5. **Custom Lambda orchestration** - Full control, high development cost

### Rationale
- n8n self-hosted allows HIPAA coverage under our own infrastructure
- Visual workflow builder accelerates development
- Existing team experience with n8n (per CLAUDE.md: "n8n: Being phased out - use only for existing workflows")
- Exception made here because alternative (Step Functions) lacks visual debugging for complex AI workflows
- Self-hosted version keeps PHI within our VPC

### Consequences
- **Positive**: Visual workflow builder speeds development
- **Positive**: PHI stays in controlled infrastructure
- **Positive**: Leverages existing team knowledge
- **Negative**: Operational burden of self-hosting
- **Negative**: n8n is being phased out per project guidelines - needs migration plan
- **Mitigation**: Document migration path to Step Functions or Temporal post-MVP
- **Follow-up**: Create migration roadmap by Phase 6 completion

---

## ADR-003: Agent Isolation Architecture

**Date**: 2026-01-31
**Status**: Accepted

### Decision
Implement strict context isolation between Rung and Beth agents through separate Bedrock inference calls with distinct system prompts and input filtering.

### Context
Two agents serve different purposes:
- **Rung**: Clinical analysis (for therapist)
- **Beth**: Client communication (accessible language)

Risk: Clinical terminology or raw session data leaking into client-facing content.

### Options Considered
1. **Single agent, multiple personas** - Simpler, risk of context bleed
2. **Separate inference calls** - Clean isolation, more API calls
3. **Separate model deployments** - Maximum isolation, highest cost
4. **Abstraction layer between agents** - Middle ground

### Rationale
- Separate inference calls with distinct system prompts provide clean boundaries
- Abstraction layer ensures Beth only receives processed themes, not raw transcripts
- Cost is manageable (2 Bedrock calls vs 1)
- Reduces risk of clinical terminology appearing in client guides
- Easier to audit what each agent receives

### Consequences
- **Positive**: Clear security boundary between clinical and client content
- **Positive**: Auditable input/output per agent
- **Positive**: Can tune each agent independently
- **Negative**: Doubled Bedrock costs for dual-output workflows
- **Negative**: Additional latency (sequential in some cases)
- **Mitigation**: Parallel processing where possible, cache common abstractions

---

## ADR-004: Couples Merge Data Isolation

**Date**: 2026-01-31
**Status**: Accepted

### Decision
Couples merge workflow operates ONLY at the framework/pattern level, never passing raw session data between partner contexts.

### Context
Couples therapy requires understanding both partners' perspectives, but individual session content is confidential. Need to find shared patterns without exposing individual PHI.

### Options Considered
1. **Full data merge** - Complete visibility, major privacy violation
2. **Framework-only merge** - Abstract patterns only, preserves privacy
3. **Therapist-mediated merge** - Manual selection, slow and error-prone
4. **No merge capability** - Safe but limits clinical utility

### Rationale
- Framework-level abstraction (e.g., "attachment anxiety pattern" vs. "said they feel abandoned when partner works late") provides clinical value
- Strict isolation prevents accidental PHI exposure
- Audit logging tracks every merge operation
- framework_only flag enforced at database level

### Consequences
- **Positive**: Preserves individual confidentiality
- **Positive**: Still provides meaningful couples insights
- **Positive**: Clear compliance boundary
- **Negative**: Some clinical nuance may be lost in abstraction
- **Negative**: Requires careful design of abstraction layer
- **Mitigation**: Work with clinical advisors to validate abstraction preserves utility

---

## ADR-005: Research API (Perplexity) Integration Strategy

**Date**: 2026-01-31
**Status**: Accepted

### Decision
Use Perplexity Labs API for evidence-based research with mandatory query anonymization before any API call.

### Context
Clinical briefs benefit from current research citations. Need external research capability but Perplexity does not offer HIPAA BAA.

### Options Considered
1. **Skip external research** - Safe but reduces clinical value
2. **Build internal research database** - High cost, maintenance burden
3. **Perplexity with anonymization** - Good results, requires careful handling
4. **PubMed API only** - Free, limited, no AI synthesis

### Rationale
- Perplexity provides excellent research synthesis with citations
- Anonymization layer strips all PHI before API calls
- Queries like "evidence-based frameworks for attachment anxiety" contain no PHI
- Adds significant clinical value to briefs

### Consequences
- **Positive**: Rich research citations improve clinical brief quality
- **Positive**: Current research (not stale database)
- **Negative**: Requires rigorous anonymization
- **Negative**: No BAA - any PHI leak is serious breach
- **Mitigation**: Automated PHI detection before API call, manual audit of sample queries, fail-safe that blocks suspicious queries

---

## ADR-006: Encryption Strategy

**Date**: 2026-01-31
**Status**: Accepted

### Decision
Implement three-layer encryption: Transport (TLS 1.3), At-rest (AWS managed), and Field-level (KMS with key hierarchy).

### Context
HIPAA requires encryption of PHI at rest and in transit. Beyond compliance, defense-in-depth is critical for healthcare data.

### Options Considered
1. **Transport + At-rest only** - Meets minimum HIPAA, simpler
2. **Full field-level encryption** - Maximum protection, complex
3. **Client-side encryption only** - Most secure, key management burden
4. **Application-level encryption** - Flexible, performance impact

### Rationale
- Field-level encryption ensures PHI is protected even if database is compromised
- KMS key hierarchy (CMK -> Therapist DEK -> Client DEK) enables fine-grained access control
- AWS-managed at-rest encryption handles underlying storage
- TLS 1.3 for all external and mTLS for internal service communication

### Consequences
- **Positive**: Defense-in-depth for PHI
- **Positive**: Per-therapist key isolation
- **Positive**: Compliance with HIPAA encryption requirements
- **Negative**: Performance overhead for encrypt/decrypt
- **Negative**: Complexity in key management
- **Negative**: Cannot search encrypted fields directly
- **Mitigation**: Cache decryption where safe, use separate searchable metadata fields

---

## ADR-007: Context Persistence with Perceptor MCP

**Date**: 2026-01-31
**Status**: Accepted

### Decision
Use Perceptor MCP (custom deployment) for longitudinal client context persistence rather than building custom context storage.

### Context
System needs to maintain context across sessions for:
- Pattern tracking over time
- Development progress
- Historical framework usage
- Session summaries

### Options Considered
1. **Custom context tables in RDS** - Full control, development cost
2. **Perceptor MCP** - Purpose-built, existing tool
3. **Vector database (Pinecone/Weaviate)** - Semantic search, overkill for structured context
4. **S3 with structured files** - Simple, limited query capability

### Rationale
- Perceptor MCP is already in use in the team's stack
- Designed for exactly this use case (context persistence across conversations)
- Can be deployed as sidecar with n8n
- Supports encryption at the storage layer
- Reduces custom development

### Consequences
- **Positive**: Leverages existing tool
- **Positive**: Reduces development time
- **Positive**: Built-in context summarization
- **Negative**: Additional component to deploy/maintain
- **Negative**: Custom integration required for healthcare use case
- **Mitigation**: Document custom encryption requirements, create healthcare-specific wrapper

---

## ADR-008: Authentication Provider

**Date**: 2026-01-31
**Status**: Accepted

### Decision
Use AWS Cognito for therapist authentication with mandatory MFA.

### Context
Need secure authentication for therapists accessing PHI. System must:
- Support MFA (HIPAA requirement for PHI access)
- Issue JWTs for API authorization
- Integrate with AWS services
- Support password policies

### Options Considered
1. **AWS Cognito** - Native AWS, HIPAA eligible, managed
2. **Auth0** - Feature-rich, HIPAA BAA available, additional vendor
3. **Okta** - Enterprise-grade, expensive for small scale
4. **Custom JWT implementation** - Maximum control, security risk

### Rationale
- Cognito is HIPAA eligible under AWS BAA (single BAA for all AWS services)
- Native integration with API Gateway and Lambda
- Supports required MFA
- Managed service reduces operational burden
- Cost-effective for expected user count

### Consequences
- **Positive**: Single BAA with AWS
- **Positive**: Native AWS integration
- **Positive**: Managed MFA
- **Negative**: Less flexible than dedicated auth providers
- **Negative**: UI customization is limited
- **Mitigation**: Use hosted UI initially, custom UI if needed post-MVP

---

## ADR-009: Notification Strategy

**Date**: 2026-01-31
**Status**: Accepted

### Decision
Use Slack for workflow status notifications with strict prohibition on PHI in any notification content.

### Context
Therapists need to know when workflows complete. Options for notification include email, SMS, push, or team messaging.

### Options Considered
1. **Email** - Universal, can include links, needs email service
2. **SMS** - Immediate, character limits, costs
3. **Push notifications** - Requires mobile app
4. **Slack** - Team already uses it, webhooks easy
5. **In-app only** - Requires polling, may miss notifications

### Rationale
- Slack is already in team workflow (per requirements)
- Simple webhook integration with n8n
- No BAA needed because NO PHI is sent to Slack
- Notifications contain only: workflow ID, status, timestamp, and generic message

### Consequences
- **Positive**: Leverages existing team tool
- **Positive**: Simple integration
- **Positive**: No PHI risk (by design)
- **Negative**: Requires therapists to use Slack
- **Negative**: Not suitable for client notifications
- **Mitigation**: Add email option for client guide delivery in future phase

---

## ADR-010: API Design Style

**Date**: 2026-01-31
**Status**: Accepted

### Decision
Use RESTful API design with resource-oriented URLs and JSON responses. No GraphQL for MVP.

### Context
Need to define API contract for client applications (web/mobile) to interact with Rung backend.

### Options Considered
1. **REST** - Well understood, tooling mature, straightforward
2. **GraphQL** - Flexible queries, single endpoint, complexity
3. **gRPC** - High performance, streaming, web browser challenges
4. **REST + GraphQL hybrid** - Best of both, operational complexity

### Rationale
- REST is simpler to implement and document
- Healthcare domain has well-defined resources (clients, sessions, briefs)
- Query flexibility of GraphQL not needed - data shapes are predictable
- Easier to secure at endpoint level
- Better tooling for OpenAPI spec generation

### Consequences
- **Positive**: Simpler implementation
- **Positive**: Clear endpoint authorization
- **Positive**: Wide tooling support (Postman, OpenAPI)
- **Negative**: May need multiple calls where GraphQL would use one
- **Negative**: Over-fetching possible
- **Mitigation**: Design efficient response schemas, add field filtering if needed

---

---

## ADR-011: Consolidate to FastAPI + ECS Fargate (Supersedes ADR-002)

**Date**: 2026-02-06
**Status**: Accepted

### Decision
Consolidate all orchestration into Python async pipelines running on ECS Fargate. Eliminate n8n entirely.

### Context
The original architecture used self-hosted n8n on EC2 for workflow orchestration (ADR-002). This created a split-brain problem: n8n sequenced HTTP calls to FastAPI endpoints that contained all the actual business logic. The n8n JavaScript abstraction layer duplicated security-critical Python code patterns. Additionally:
- Self-hosted n8n has no HIPAA BAA coverage
- Required maintaining two languages (Python + JavaScript) for security-critical code
- Visual workflows had limited debuggability for complex error states
- n8n requires separate EC2 instance, ALB, and PostgreSQL database
- Deployment complexity increased with multiple components

### Options Considered
1. **Keep n8n, harden security** - Continue current split-brain, add more controls
2. **Migrate to AWS Step Functions** - Replace n8n with AWS native, still split from app logic
3. **Consolidate to Python async pipelines** - Single language, single deployment
4. **Use Temporal** - Better reliability, steeper learning curve, additional infrastructure

### Rationale
- All business logic already exists in Python services (`src/services/`)
- Async Python pipelines provide equivalent sequencing without abstraction layer
- Single Docker container deployment simplifies operations
- ECS Fargate appropriate for 2-5 minute pipeline execution times (Lambda 15min limit insufficient)
- All security-critical code in one language (Python) improves auditability
- Eliminates 1 EC2 instance, 1 ALB, 1 PostgreSQL database
- Structured logging + pipeline status tracking provides debugging visibility
- Single ALB → ECS → RDS/S3/Bedrock architecture

### Implementation
- Created `src/pipelines/` with async pipeline orchestration:
  - `pre_session.py` - Voice memo → Clinical brief + Client guide
  - `post_session.py` - Session notes → Development plan
  - `couples_merge.py` - Framework-level partner insights
- Consolidated Lambda handlers into FastAPI endpoints (`src/api/`)
- Added centralized services:
  - `src/services/encryption.py` - KMS envelope encryption
  - `src/services/audit.py` - HIPAA audit logging
  - `src/services/progress_analytics.py` - Client development tracking
- Added Alembic migrations (`src/db/alembic/`)
- Created ECS Fargate deployment infrastructure (`terraform/modules/ecs/`)
- Moved n8n directory to `n8n.deprecated/` (preserved for reference)
- Lambda files marked deprecated but preserved for test compatibility

### Consequences
- **Positive**: Single deployment unit (Docker container)
- **Positive**: All security code in Python (easier HIPAA audit)
- **Positive**: Reduced infrastructure cost (no EC2, ALB, RDS for n8n)
- **Positive**: Simplified credential management (no n8n credential store)
- **Positive**: Faster development (no context switching between languages)
- **Negative**: Lost visual workflow debugging (mitigated by structured logging + status endpoints)
- **Negative**: Pipeline errors require log analysis instead of visual inspection
- **Mitigation**: Comprehensive logging, pipeline status tracking, FastAPI `/health` and `/pipelines/{id}/status` endpoints

---

## ADR-012: Reading List PHI Boundaries

**Date**: 2026-02-09
**Status**: Accepted

### Decision
Implement reading list feature with clear PHI boundary: article URLs/titles/sources are NOT PHI, but client notes and therapist assignment notes ARE PHI and must be encrypted.

### Context
Client wants to tag articles from Psychology Today and books for therapy session discussion. The feature includes free-text notes where clients reflect on readings and therapist instructions that may reference treatment context. Need clear PHI classification for each field.

### Options Considered
1. **Encrypt everything** - Maximum security, performance overhead, can't search/display titles
2. **Encrypt notes only** - URLs/titles are public content, notes contain psychological reflections
3. **No encryption** - Fastest, violates HIPAA for note content

### Rationale
- Article URLs and titles are publicly available content (e.g., Psychology Today articles)
- Client notes (`notes_encrypted`) contain personal psychological reflections = PHI
- Therapist assignment notes (`assignment_notes_encrypted`) may contain clinical context referencing treatment (e.g., "Read this about grief - relates to your mother's passing") = PHI
- Pipeline context output includes titles/URLs but explicitly excludes encrypted note content
- Soft delete preserves records for HIPAA audit trail while removing from active queries

### Implementation
- `url`, `title`, `source` columns: plaintext `String` (not PHI)
- `notes_encrypted`: `LargeBinary` with KMS envelope encryption (PHI)
- `assignment_notes_encrypted`: `LargeBinary` with KMS envelope encryption (PHI)
- `deleted_at`: soft delete column (nullable DateTime)
- Pipeline context: indicates "client added personal notes" without exposing content
- List endpoint: returns `has_notes` boolean, NOT decrypted content
- Detail endpoint: decrypts notes with audit logging

### Consequences
- **Positive**: Clear PHI boundary enables safe pipeline integration
- **Positive**: Titles/sources available for display without decryption overhead
- **Positive**: Audit trail preserved via soft delete
- **Positive**: Notes-present indicator in pipeline context avoids PHI leak
- **Negative**: Two-tier response model (list vs detail) adds complexity
- **Mitigation**: ReadingItemRead (list) and ReadingItemDetail (detail) Pydantic schemas make boundary explicit

---

## Pending Decisions

### PDR-001: Post-MVP Migration from n8n
- **Context**: n8n is being phased out per team guidelines
- **Status**: RESOLVED - See ADR-011
- **Resolution**: Migrated to Python async pipelines on ECS Fargate

### PDR-002: Client Notification System
- **Context**: Currently only therapist notifications via Slack
- **Options**: Email, SMS, in-app, push
- **Timeline**: Post-MVP based on beta feedback
- **Owner**: TBD

### PDR-003: Multi-Tenancy Architecture
- **Context**: Current design is single-practice; may need multi-tenant for scale
- **Options**: Database per tenant, schema per tenant, row-level isolation
- **Timeline**: Evaluate after beta
- **Owner**: TBD

---

*Log maintained by: Backend Architect*
*Last Updated: 2026-02-09*
